(()=>{"use strict";class e{constructor(e,t,s,n,i){this._data=e,this._name=e.name,this._link=e.link,this._myId=e.myId,this._likes=e.likes,this._likesLength=e.likes.length,this._ownerId=e.owner._id,this._cardId=e._id,this._templateSelector=t,this._openZoomImage=s,this._openDeletePopup=n,this._changelLike=i}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".element").cloneNode(!0)}_handleCardClick=()=>{this._openZoomImage(this._data)};_handleLikeImage=()=>{this._changelLike(this._elementLike,this._cardId)};_handleImageDelete=()=>{this._openDeletePopup(this)};_checkDeleteButton(){this._myId===this._ownerId?this._elementDelete.style.display="block":this._elementDelete.style.display="none"}_checkLikes(){this._likes.forEach((e=>{e._id!==this._myId||this._elementLike.classList.add("element__like_active")})),this._counter.textContent=this._likesLength}isLiked(e){this._elementLike.classList.toggle("element__like_active"),this._counter.textContent=e.length}removeCard(){this._element.remove(),this._element=null}_setEventListeners(){this._elementImage.addEventListener("click",this._handleCardClick),this._elementLike.addEventListener("click",this._handleLikeImage),this._elementDelete.addEventListener("click",this._handleImageDelete)}generateCard(){return this._element=this._getTemplate(),this._elementImage=this._element.querySelector(".element__image"),this._elementLike=this._element.querySelector(".element__like"),this._elementDelete=this._element.querySelector(".element__delete"),this._counter=this._element.querySelector(".element__counter"),this._checkLikes(),this._setEventListeners(),this._element.querySelector(".element__image").src=this._link,this._element.querySelector(".element__title").textContent=this._name,this._checkDeleteButton(),this._element}}const t=class{constructor(e,t){this._form=t,this._formSelector=e.formSelector,this._inputSelector=e.inputSelector,this._submitButtonSelector=e.submitButtonSelector,this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClass=e.errorClass,this._errorSpan=e.errorSpan,this._savedButton=this._form.querySelector(this._submitButtonSelector)}_showInputError(e,t){e.classList.add(this._inputErrorClass),t.textContent=e.validationMessage,t.classList.add(this._errorSpan)}_hideInputError(e,t){e.classList.remove(this._inputErrorClass),t.textContent="",t.classList.remove(this._errorSpan)}_checkValidity(e){const t=document.querySelector(`#error-${e.id}`);e.validity.valid?this._hideInputError(e,t):this._showInputError(e,t)}_disableButton(){this._savedButton.setAttribute("disabled",""),this._savedButton.classList.add(this._inactiveButtonClass)}_enableButton(){this._savedButton.removeAttribute("disabled"),this._savedButton.classList.remove(this._inactiveButtonClass)}_validityButton(){this._form.checkValidity()?this._enableButton():this._disableButton()}enableValidation(){this._form.addEventListener("submit",(function(e){e.preventDefault()}));const e=this._form.querySelectorAll(this._inputSelector);Array.from(e).forEach((e=>{e.addEventListener("input",(()=>{this._checkValidity(e),this._validityButton()}))})),this._form.addEventListener("reset",(e=>{this._disableButton()}))}};class s{constructor(e){this._popup=document.querySelector(e),this._closeButton=this._popup.querySelector(".popup__close"),this._form=this._popup.querySelector(".popup__form")}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose=e=>{"Escape"===e.key&&this.close()};_handleCloseButton=()=>{this.close()};_handleClickOverlay=e=>{(e.target.classList.contains("popup_opened")||e.target.classList.contains("popup__close"))&&this.close()};setEventListeners(){this._popup.addEventListener("click",this._handleClickOverlay)}}class n extends s{constructor(e,t){super(e),this._submitFunction=t,this._inputList=this._form.querySelectorAll(".popup__input")}_getInputValues(){return this._values={},this._inputList.forEach((e=>{this._values[e.name]=e.value})),this._values}setInputValues(e){this._inputList.forEach((t=>{t.value=e[t.name]}))}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._submitFunction(this._getInputValues()),this.close()}))}close(){super.close(),this._form.reset()}}const i=document.querySelector(".popup_type_profil"),o=document.querySelector(".profile__button-info"),r=i.querySelector(".popup__form_type_profil"),a=document.querySelector(".popup_avatar").querySelector(".popup__form-avatar"),l=document.querySelector(".profile__button"),_=document.querySelector(".popup__form-add"),h={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__submit",inactiveButtonClass:"popup__submit_add",inputErrorClass:"popup__input_type_error",errorClass:"form__input-error_visible",errorSpan:"form__input-error"},c=new class extends s{constructor(e){super(e),this._popupImage=this._popup.querySelector(".popup__zoom-image"),this._popupCaption=this._popup.querySelector(".popup__zoom-title")}open=e=>{this._popupImage.src=e.link,this._popupImage.alt=e.name,this._popupCaption.textContent=e.name,super.open()}}(".popup_type_zoom-card"),u=new class{constructor(e){this._inputName=document.querySelector(e.profileNameSelector),this._inputInfo=document.querySelector(e.profileInfoSelector),this._profileAvatar=document.querySelector(e.profileAvatarSelector)}getUserInfo(){return{name:this._inputName.textContent,subname:this._inputInfo.textContent}}setUserInfo({avatar:e,name:t,subname:s}){this._profileAvatar.src=e,this._inputName.textContent=t,this._inputInfo.textContent=s}}({profileNameSelector:".profile__title",profileInfoSelector:".profile__subtitle",profileAvatarSelector:".profile__avatar"});new t(h,a).enableValidation(),new t(h,r).enableValidation(),new t(h,_).enableValidation();const p=new class{constructor(e){this._url=e.baseUrl,this._headers=e.headers,this._authorization=e.headers.authorization}_checkResponse(e){return e.ok?e.json():Promise.reject}getInfo(){return fetch(`${this._url}/users/me`,{headers:{authorization:this._authorization}}).then(this._checkResponse)}getCards(){return fetch(`${this._url}/cards`,{headers:{authorization:this._authorization}}).then(this._checkResponse)}setUserInfo(e){return fetch(`${this._url}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e.name,about:e.subname})}).then(this._checkResponse)}setNewAvatar(e){return fetch(`${this._url}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e.avatar})}).then(this._checkResponse)}addCard(e){return fetch(`${this._url}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:e.title,link:e.link})}).then(this._checkResponse)}addLike(e){return fetch(`${this._url}/cards/${e}/likes`,{method:"PUT",headers:{authorization:this._authorization}}).then(this._checkResponse)}deleteLike(e){return fetch(`${this._url}/cards/${e}/likes`,{method:"DELETE",headers:{authorization:this._authorization}}).then(this._checkResponse)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-74",headers:{authorization:"66845714-5b02-4496-8606-3df242518ec7","Content-Type":"application/json"}}),d=new class extends s{constructor(e,t){super(e),this._submitFunction=t}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._submitFunction(this._elemint)}))}open=e=>{super.open(),this._elemint=e}}(".popup_delete",(e=>{e.removeCard(),d.close()}));function m(t){const s=new e(t,".element__template",c.open,d.open,((e,t)=>{console.log(t),e.classList.contains("element__like_active")?p.deleteLike(t).then((e=>{s.isLiked(e.likes)})).catch((e=>console.log(`Ошибка при снятии лайка ${e}`))):p.addLike(t).then((e=>{s.isLiked(e.likes)})).catch((e=>console.log(`Ошибка при добавлении лайка ${e}`)))}));return s.generateCard()}const v=new class{constructor(e,t){this._container=document.querySelector(t),this._renderer=e}renderItems(e){e.forEach((e=>{this._renderer(e)}))}addItemPrepend(e){this._container.prepend(e)}addItemAppend(e){this._container.append(e)}}((e=>{v.addItemPrepend(m(e))}),".elements"),f=new n(".popup_type_profil",(e=>{p.setUserInfo(e).then((e=>{u.setUserInfo({name:e.name,subname:e.about,avatar:e.avatar})})).catch((e=>console.log(`Ошибка при редактировании профиля ${e}`))).finally()})),k=new n(".popup_add",(e=>{Promise.all([p.getInfo(),p.addCard(e)]).then((([e,t])=>{t.myId=e._id,v.addItemPrepend(m(t)),k.close()})).catch((e=>console.log(`Ошибка при создании новой карточки ${e}`))).finally()})),y=new n(".popup_avatar",(e=>{p.setNewAvatar(e).then((e=>{u.setUserInfo({name:e.name,subname:e.about,avatar:e.avatar})})).catch((e=>console.log(`Ошибка при обновлении аватара ${e}`))).finally()}));o.addEventListener("click",(()=>(f.open(),void f.setInputValues(u.getUserInfo())))),l.addEventListener("click",(()=>{k.open()})),c.setEventListeners(),f.setEventListeners(),k.setEventListeners(),y.setEventListeners(),d.setEventListeners(),document.querySelector(".profile__button_avatar").addEventListener("click",(()=>{y.open()})),Promise.all([p.getInfo(),p.getCards()]).then((([e,t])=>{t.forEach((t=>t.myId=e._id)),u.setUserInfo({name:e.name,subname:e.about,avatar:e.avatar}),v.renderItems(t)})).catch((e=>console.log(`Ошибка при создании начальных данных ${e}`)))})();